import{c as E,aq as k,ar as b,u as v,r as o,bG as W,j as e,e8 as _,a5 as f,aH as z,aI as P,aJ as $,bv as A,aV as J,e as K,bH as G,bI as Q,dr as Y,O as X,bJ as Z,e9 as ee,ea as ae,L as C,ac as S,I,cK as se,d as ne,dL as le,dM as re,dN as te,dO as ce,Y as q,eb as ie,b as F,V as H,W as oe,bL as D,U,ec as de,bW as me,aR as ue,bs as he,aW as pe,ed as L,ee as xe,ef as je,bM as fe,aL as M,bk as ye,dm as R,dn as V,eg as ge,dp as we,J as Ne,a3 as ve,a6 as Ce,a7 as ke,a8 as be,as as Me,a9 as Se,bR as De,bS as Te,bT as Ae,bV as Ie}from"./index.59694a49.js";import{R as Le,a as Re}from"./radio-group.dc3d14ec.js";import{T as Ve,a as Be,b as B,e as p,d as Oe}from"./table.ca326b4a.js";import{O}from"./OperationAction.02f00643.js";import{d as Ee,e as ze}from"./hook.891b1d97.js";import{g as Pe}from"./charge.71dc8391.js";import{A as $e}from"./activity.8e8b97fa.js";import{B as qe}from"./box.1754403d.js";import{M as Fe}from"./minus.dba63f79.js";import{C as He}from"./cloud-upload.7e0de19a.js";import"./funnel.1dc762bc.js";import"./groups.c24f8e23.js";/**
 * @license lucide-react v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M12 13v8l-4-4",key:"1f5nwf"}],["path",{d:"m12 21 4-4",key:"1lfcce"}],["path",{d:"M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284",key:"ui1hmy"}]],We=E("CloudDownload",Ue);/**
 * @license lucide-react v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=[["path",{d:"M8 7v7",key:"1x2jlm"}],["path",{d:"M12 7v4",key:"xawao1"}],["path",{d:"M16 7v9",key:"1hp2iy"}],["path",{d:"M5 3a2 2 0 0 0-2 2",key:"y57alp"}],["path",{d:"M9 3h1",key:"1yesri"}],["path",{d:"M14 3h1",key:"1ec4yj"}],["path",{d:"M19 3a2 2 0 0 1 2 2",key:"18rm91"}],["path",{d:"M21 9v1",key:"mxsmne"}],["path",{d:"M21 14v1",key:"169vum"}],["path",{d:"M21 19a2 2 0 0 1-2 2",key:"1j7049"}],["path",{d:"M14 21h1",key:"v9vybs"}],["path",{d:"M9 21h1",key:"15o7lz"}],["path",{d:"M5 21a2 2 0 0 1-2-2",key:"sbafld"}],["path",{d:"M3 14v1",key:"vnatye"}],["path",{d:"M3 9v1",key:"1r0deq"}]],Je=E("SquareDashedKanban",_e);async function Ke(){try{return(await k.get("/admin/charge/list")).data}catch(a){return{status:!1,error:b(a),data:[]}}}async function Ge(a){try{return(await k.post("/admin/charge/set",a)).data}catch(s){return{status:!1,error:b(s)}}}async function Qe(a){try{return(await k.get(`/admin/charge/delete/${a}`)).data}catch(s){return{status:!1,error:b(s)}}}async function Ye(a){try{return(await k.post("/admin/charge/sync",a)).data}catch(s){return{status:!1,error:b(s)}}}async function Xe(a){try{const i=(await k.post("/admin/charge/fetch",a)).data;return{status:!!i.status,error:i.error,data:i.data||[]}}catch(s){return{status:!1,error:b(s),data:[]}}}const T={id:-1,type:_,models:[],anonymous:!1,input:0,output:0};function Ze(a,s){switch(s.type){case"set":return{...s.payload};case"set-models":return{...a,models:s.payload};case"add-model":const i=s.payload.trim();return i.length===0||a.models.includes(i)?a:{...a,models:[...a.models,i]};case"toggle-model":return s.payload.trim().length===0?a:a.models.includes(s.payload)?{...a,models:a.models.filter(l=>l!==s.payload)}:{...a,models:[...a.models,s.payload]};case"remove-model":return{...a,models:a.models.filter(l=>l!==s.payload)};case"set-type":return{...a,type:s.payload};case"set-anonymous":return{...a,anonymous:s.payload};case"set-input":return{...a,input:s.payload};case"set-output":return{...a,output:s.payload};case"clear":return T;case"clear-param":return{...T,id:a.id};default:return a}}function ea(a){switch(a.models=a.models.map(s=>s.trim()).filter(s=>s.length>0),a.type){case q:a.input=0,a.output=0;break;case H:a.input=0,a.anonymous=!1;break;case U:a.anonymous=!1;break}return a.input<0&&(a.input=0),a.output<0&&(a.output=0),a}function aa({builtin:a,current:s,open:i,setOpen:l,onRefresh:u,system:r}){const{t}=v(),[c,x]=o.useState([]),[g,m]=o.useState(!1),[j,w]=o.useState(!1),d=o.useMemo(()=>c.flatMap(n=>n.models),[c]),N=o.useMemo(()=>j?d:d.filter(n=>!s.includes(n)),[j,d,s]);return e.jsxs(e.Fragment,{children:[e.jsx(R,{type:V.Number,title:t("admin.charge.sync-builtin"),name:t("admin.charge.usd-currency"),open:i&&a,setOpen:l,defaultValue:"7.1",onSubmit:async n=>{const h=ge(n),y=Pe(h);return x(y),m(!0),!0}}),e.jsx(R,{type:V.Text,title:t("admin.charge.sync"),name:t("admin.charge.sync-site"),placeholder:t("admin.charge.sync-placeholder"),open:i&&!a,setOpen:l,defaultValue:"https://api.chatnio.net",alert:r===""?t("admin.coai-format-only"):void 0,onSubmit:async n=>{const h=r==="newapi"?`${n.replace(/\/$/,"")}/api/ratio_config`:we("/v1/charge",{endpoint:n}),y=await Xe({endpoint:n,system:r});return!y.status||y.data.length===0?(Ne.error(t("admin.charge.sync-failed"),{description:t("admin.charge.sync-failed-prompt",{endpoint:h})}),!1):(x(y.data),m(!0),!0)}}),e.jsx(ve,{open:g,onOpenChange:m,children:e.jsxs(Ce,{children:[e.jsxs(ke,{children:[e.jsx(be,{children:t("admin.charge.sync-option")}),e.jsx(Me,{className:"pt-1.5",children:t("admin.charge.sync-prompt",{length:d.length,influence:N.length})})]}),e.jsxs("div",{className:"pt-1 flex flex-row items-center justify-center",children:[e.jsx("span",{className:"mr-4 whitespace-nowrap",children:t("admin.charge.sync-overwrite")}),e.jsx(F,{checked:j,onCheckedChange:w})]}),e.jsxs(Se,{children:[e.jsx(f,{unClickable:!0,variant:"outline",onClick:()=>{m(!1),x([])},children:t("cancel")}),e.jsx(f,{unClickable:!0,loading:!0,variant:j?"destructive":"default",onClick:async()=>{const n=await Ye({data:c,overwrite:j});M(t,n,!0),n.status&&(l(!1),m(!1),x([]),u())},children:t("admin.charge.sync-confirm")})]})]})})]})}function sa({loading:a,onRefresh:s,currentModels:i}){const{t:l}=v(),[u,r]=o.useState(!1),[t,c]=o.useState(!1),[x,g]=o.useState(""),m=j=>{c(j),r(!0)};return e.jsxs("div",{className:"flex flex-row w-full h-max",children:[e.jsx(aa,{builtin:t,onRefresh:s,current:i,open:u,setOpen:r,system:x}),e.jsxs(f,{variant:"default",className:"mr-2",onClick:()=>m(!0),children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),l("admin.charge.sync-builtin")]}),e.jsxs(z,{children:[e.jsx(P,{asChild:!0,children:e.jsxs(f,{variant:"outline",children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),l("admin.charge.sync")]})}),e.jsxs($,{align:"start",children:[e.jsx(A,{onSelect:()=>{g(""),m(!1)},children:"CoAI"}),e.jsx(A,{onSelect:()=>{g("newapi"),m(!1)},children:"NewAPI"})]})]}),e.jsx("div",{className:"grow"}),e.jsx(f,{variant:"outline",size:"icon",onClick:s,children:e.jsx(J,{className:K("w-4 h-4",a&&"animate-spin")})})]})}function na({models:a,onClick:s}){const{t:i}=v();return a.length>0&&e.jsxs(G,{className:"charge-alert",children:[e.jsxs(Q,{className:"flex flex-row items-center select-none",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),e.jsx("p",{children:i("admin.charge.unused-model")}),e.jsx(X,{content:i("admin.charge.unused-model-tip")})]}),e.jsx(Z,{className:"model-list",children:a.slice(0,15).map((l,u)=>e.jsxs(f,{variant:"outline",className:"cursor-pointer h-8 select-none flex flex-row items-center",onClick:()=>s(l),children:[e.jsx(qe,{className:"w-3.5 h-3.5 mr-1"}),l]},u))})]})}function la({form:a,dispatch:s,onRefresh:i,usedModels:l,allModels:u}){const{t:r}=v(),[t,c]=o.useState(""),x=o.useMemo(()=>ee([...u,...ze]),[u]),g=o.useMemo(()=>x.filter(n=>!a.models.includes(n)&&!l.includes(n)&&n.trim()!==""),[a.models,l]),m=o.useMemo(()=>t.trim()!==""?!1:a.models.length===0,[t,a.models]),[j,w]=o.useState(!1);async function d(){const n=t.trim(),h=ea({...a});n!==""&&!h.models.includes(n)&&(h.models=[n,...h.models],c(""));const y=await Ge(h);M(r,y,!0),y.status&&N(),i()}function N(){s({type:"clear"}),c("")}return e.jsxs("div",{className:"charge-editor",children:[e.jsx("div",{className:"w-full h-max mb-5",children:e.jsx(Le,{value:a.type,onValueChange:n=>s({type:"set-type",payload:n}),className:"flex flex-row gap-5 whitespace-nowrap flex-wrap",children:ae.map((n,h)=>e.jsxs("div",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx(Re,{className:"transition-all duration-200",value:n,id:n}),e.jsx(C,{htmlFor:n,className:"cursor-pointer",children:r(`admin.charge.${n}`)})]},h))})}),e.jsxs("div",{className:"flex flex-row w-full h-max mb-4",children:[e.jsx(f,{onClick:()=>{s({type:"add-model",payload:t}),c("")},size:"icon",className:"mr-2 shrink-0",children:e.jsx(S,{className:"w-4 h-4"})}),e.jsx(I,{value:t,onChange:n=>c(n.target.value),placeholder:r("admin.channels.model"),onKeyDown:n=>{se(n)&&(s({type:"add-model",payload:t}),c(""))}}),e.jsxs(z,{children:[e.jsx(P,{asChild:!0,children:e.jsx(f,{size:"icon",className:"ml-2 shrink-0",children:e.jsx(ne,{className:"w-4 h-4"})})}),e.jsx($,{align:"end",asChild:!0,children:e.jsxs(le,{children:[e.jsx(re,{placeholder:r("admin.channels.search-model")}),e.jsx(te,{className:"thin-scrollbar",children:g.map((n,h)=>e.jsx(ce,{value:n,onSelect:y=>s({type:"add-model",payload:y}),className:"px-2",children:n},h))})]})})]})]}),e.jsx("div",{className:"flex flex-col w-full h-max mb-2",children:a.models.map((n,h)=>e.jsxs("div",{className:"flex flex-row w-full h-max shrink-0 mb-2 select-none",children:[e.jsx(I,{value:n,readOnly:!0}),e.jsx(f,{onClick:()=>s({type:"remove-model",payload:n}),size:"icon",variant:"outline",className:"ml-2 shrink-0",children:e.jsx(Fe,{className:"w-4 h-4"})})]},h))}),a.type===q&&e.jsxs("div",{className:"flex flex-row w-full h-max items-center mt-4 mb-6",children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),e.jsx(C,{className:"grow",children:r("admin.charge.anonymous")}),e.jsx(F,{checked:a.anonymous,onCheckedChange:n=>s({type:"set-anonymous",payload:n})})]}),a.type===H&&e.jsxs("div",{className:"flex flex-row w-full h-max items-center",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),e.jsx(C,{className:"grow",children:r("admin.charge.time-count")}),e.jsx(D,{value:a.output,onValueChange:n=>s({type:"set-output",payload:n}),acceptNegative:!1,className:"w-20",min:0,max:99999})]}),a.type===U&&e.jsxs("div",{className:"flex flex-col w-full h-max gap-2",children:[e.jsxs("div",{className:"flex flex-row w-full h-max items-center",children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),e.jsxs(C,{className:"grow",children:[r("admin.charge.input-count"),e.jsx("span",{className:"token",children:" / 1k tokens"})]}),e.jsx(D,{value:a.input,onValueChange:n=>s({type:"set-input",payload:n}),acceptNegative:!1,className:"w-20",min:0,max:99999})]}),e.jsxs("div",{className:"flex flex-row w-full h-max items-center",children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),e.jsxs(C,{className:"grow",children:[r("admin.charge.output-count"),e.jsx("span",{className:"token",children:" / 1k tokens"})]}),e.jsx(D,{value:a.output,onValueChange:n=>s({type:"set-output",payload:n}),acceptNegative:!1,className:"w-20",min:0,max:99999})]})]}),e.jsxs("div",{className:"flex flex-row w-full h-max mt-5 gap-2 items-center flex-wrap",children:[e.jsxs("div",{className:"object-id",children:[e.jsx("span",{className:"mr-2",children:"ID"}),a.id===-1?e.jsx(S,{className:"w-3 h-3"}):e.jsx("span",{className:"id",children:a.id})]}),e.jsx("div",{className:"grow"}),e.jsx(f,{variant:"outline",size:"icon",className:"shrink-0",onClick:N,children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx(f,{disabled:m,onClick:d,loading:!0,onLoadingChange:w,className:"whitespace-nowrap shrink-0",children:a.id===-1?e.jsxs(e.Fragment,{children:[!j&&e.jsx(S,{className:"w-4 h-4 mr-2"}),r("admin.charge.add-rule")]}):e.jsxs(e.Fragment,{children:[!j&&e.jsx(me,{className:"w-4 h-4 mr-2"}),r("admin.charge.update-rule")]})})]})]})}function ra({data:a,dispatch:s,onRefresh:i}){const{t:l}=v(),u=ue();return e.jsx("div",{className:"charge-table",children:e.jsxs(Ve,{classNameWrapper:"table",children:[e.jsx(Be,{children:e.jsxs(B,{className:"select-none whitespace-nowrap",children:[e.jsx(p,{children:l("admin.charge.id")}),e.jsx(p,{children:l("admin.charge.type")}),e.jsx(p,{children:l("admin.charge.model")}),e.jsx(p,{children:l("admin.charge.input")}),e.jsx(p,{children:l("admin.charge.output")}),e.jsx(p,{children:l("admin.charge.support-anonymous")}),e.jsx(p,{children:l("admin.charge.action")})]})}),e.jsx(Oe,{children:a.map((r,t)=>e.jsxs(B,{children:[e.jsx(p,{className:"charge-id",children:r.id}),e.jsx(p,{children:e.jsx(he,{className:"whitespace-nowrap",children:l(`admin.charge.${r.type}`)})}),e.jsx(p,{children:r.models.map((c,x)=>e.jsxs("p",{className:"whitespace-nowrap cursor-pointer",onClick:()=>u(c),children:[c,e.jsx(pe,{className:"inline w-3 h-3 ml-1"})]},x))}),e.jsx(p,{children:L(r.input)}),e.jsx(p,{children:L(r.output)}),e.jsx(p,{children:l(String(r.anonymous))}),e.jsx(p,{children:e.jsxs("div",{className:"inline-flex flex-row flex-wrap gap-2",children:[e.jsx(O,{tooltip:l("admin.channels.edit"),onClick:async()=>{const c={...r};s({type:"set",payload:c}),xe(je(".admin-content > .scrollarea-viewport"))},children:e.jsx(fe,{className:"h-4 w-4"})}),e.jsx(O,{tooltip:l("admin.channels.delete"),variant:"destructive",onClick:async()=>{const c=await Qe(r.id);M(l,c,!0),i()},children:e.jsx(ye,{className:"h-4 w-4"})})]})})]},t))})]})})}function ta(){const{t:a}=v(),[s,i]=o.useState([]),[l,u]=o.useReducer(Ze,T),[r,t]=o.useState(!1),{allModels:c,update:x}=Ee(),g=o.useMemo(()=>s.flatMap(d=>d.models),[s]),m=o.useMemo(()=>s.flatMap(d=>d.models),[s]),j=o.useMemo(()=>r?[]:c.filter(d=>!m.includes(d)&&d.trim()!==""),[r,c,m]);async function w(d){t(!0);const N=await Ke();d||await x(),t(!1),M(a,N),i(N.data)}return W(async()=>await w(!0),[]),e.jsxs("div",{className:"charge-widget",children:[e.jsx(sa,{loading:r,onRefresh:w,currentModels:g}),e.jsx(na,{models:j,onClick:d=>u({type:"toggle-model",payload:d})}),e.jsx(la,{onRefresh:w,form:l,dispatch:u,allModels:c,usedModels:m}),e.jsx(ra,{data:s,dispatch:u,onRefresh:w})]})}function ga(){const{t:a}=v();return e.jsx("div",{className:"charge",children:e.jsxs(De,{className:"admin-card charge-card",children:[e.jsx(Te,{className:"select-none",children:e.jsx(Ae,{children:a("admin.prize")})}),e.jsx(Ie,{children:e.jsx(ta,{})})]})})}export{ga as default};
