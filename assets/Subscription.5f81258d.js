import{eN as F,aq as O,ar as $,u as M,j as e,bR as q,bS as H,bT as U,bV as G,r as v,t as J,e9 as W,bG as _,dm as K,dn as Q,eO as X,a5 as u,f as Y,cV as Z,cW as ee,aV as se,e as g,b as T,af as A,O as w,bL as S,I as V,bO as ae,bi as le,bj as ne,bk as ie,ac as te,aH as re,aI as de,aJ as oe,bv as ce,aL as me,eP as pe}from"./index.59694a49.js";import{a as ue}from"./hook.891b1d97.js";import{A as ve}from"./activity.8e8b97fa.js";import{S as xe}from"./save.ae5a8960.js";import{B as he}from"./book-dashed.b14c78b1.js";import"./groups.c24f8e23.js";async function fe(){try{const l=(await O.get("/admin/plan/view")).data;return l.plans=(l.plans||[]).filter(r=>r.level>0),l.plans.length===0&&(l.plans=[1,2,3].map(r=>({level:r,price:0,items:[]}))),l}catch(s){return console.warn(s),{enabled:!1,plans:[]}}}async function ye(s){const l=await F({endpoint:s});return{enabled:l.length>0,plans:l}}async function je(s){try{return(await O.post("/admin/plan/update",s)).data}catch(l){return{status:!1,error:$(l)}}}const ge={enabled:!1,plans:[]};function we(s,l){switch(l.type){case"set":return l.payload;case"set-enabled":return{...s,enabled:l.payload};case"set-price":return{...s,plans:s.plans.map(a=>a.level===l.payload.level?{...a,price:l.payload.price}:a)};case"set-item-id":return{...s,plans:s.plans.map(a=>a.level===l.payload.level?{...a,items:a.items.map((n,t)=>t===l.payload.index?{...n,id:l.payload.id}:n)}:a)};case"set-item-name":return{...s,plans:s.plans.map(a=>a.level===l.payload.level?{...a,items:a.items.map((n,t)=>t===l.payload.index?{...n,name:l.payload.name}:n)}:a)};case"set-item-value":return{...s,plans:s.plans.map(a=>a.level===l.payload.level?{...a,items:a.items.map((n,t)=>t===l.payload.index?{...n,value:l.payload.value}:n)}:a)};case"set-item-icon":return{...s,plans:s.plans.map(a=>a.level===l.payload.level?{...a,items:a.items.map((n,t)=>t===l.payload.index?{...n,icon:l.payload.icon}:n)}:a)};case"add-item":return{...s,plans:s.plans.map(a=>a.level===l.payload.level?{...a,items:[...a.items,{id:"",name:"",value:0,icon:"",models:[]}]}:a)};case"set-item-models":return{...s,plans:s.plans.map(a=>a.level===l.payload.level?{...a,items:a.items.map((n,t)=>t===l.payload.index?{...n,models:l.payload.models}:n)}:a)};case"remove-item":return{...s,plans:s.plans.map(a=>a.level===l.payload.level?{...a,items:a.items.filter((n,t)=>t!==l.payload.index)}:a)};case"upward-item":return{...s,plans:s.plans.map(a=>{if(a.level===l.payload.level){const n=a.items,t=l.payload.index;if(t>0){const N=n[t];n[t]=n[t-1],n[t-1]=N}return{...a,items:n}}return a})};case"downward-item":return{...s,plans:s.plans.map(a=>{if(a.level===l.payload.level){const n=a.items,t=l.payload.index;if(t<n.length-1){const N=n[t];n[t]=n[t+1],n[t+1]=N}return{...a,items:n}}return a})};case"import-item":const{level:r,id:h,target:f}=l.payload,m=s.plans.find(a=>a.level===r),c=m==null?void 0:m.items.find(a=>a.id===h);return!m||!c?s:{...s,plans:s.plans.map(a=>{if(a.level===f){const n=a.items;return n.push(c),{...a,items:n}}return a})};case"set-discount":return{...s,plans:s.plans.map(a=>{if(a.level===l.payload.level){const n=a.discounts||{};return n[l.payload.month]=l.payload.value,{...a,discounts:n}}return a})};case"remove-discount":return{...s,plans:s.plans.map(a=>{if(a.level===l.payload.level&&a.discounts){const n={...a.discounts};return delete n[l.payload.month],{...a,discounts:n}}return a})};default:throw new Error}}function Ne({plans:s,level:l,dispatch:r}){const{t:h}=M(),f=v.useMemo(()=>s.filter(c=>c.level!==l).map(c=>c.items.map(a=>({level:c.level,item:a}))).flat(),[s,l]);return e.jsxs(re,{children:[e.jsx(de,{asChild:!0,children:e.jsxs(u,{variant:"outline",children:[e.jsx(he,{className:"h-4 w-4 mr-1"}),h("admin.plan.import-item")]})}),e.jsx(oe,{children:f.map(({level:m,item:c},a)=>e.jsxs(ce,{onClick:()=>{r({type:"import-item",payload:{level:m,id:c.id,target:l}})},children:[h(`sub.${A(m)}`)," - ",c.name," (",c.id,")"]},a))})]})}function be(){const{t:s}=M(),[l,r]=v.useReducer(we,ge),[h,f]=v.useState(!1),m=J(),{channelModels:c,update:a}=ue(),[n,t]=v.useState(!1),[N,D]=v.useState(!1),[E,P]=v.useState(!1),[y,R]=v.useState(null),b=v.useMemo(()=>y?y.plans.flatMap(i=>i.items):[],[y]),L=v.useMemo(()=>W(b.flatMap(i=>i.models)),[b]),I=async i=>{f(!0);const x=await fe();i||await a(),r({type:"set",payload:x}),f(!1)},C=async i=>{const x=await je(i??l);me(s,x,!0),x.status&&pe(m,l.enabled?l.plans:[])};return _(async()=>await I(!0),[]),e.jsxs("div",{className:"plan-config",children:[e.jsx(K,{type:Q.Text,title:s("admin.plan.sync"),name:s("admin.plan.sync-site"),placeholder:s("admin.plan.sync-placeholder"),open:N,setOpen:D,defaultValue:"https://api.chatnio.net",alert:s("admin.coai-format-only"),onSubmit:async i=>{const x=await ye(i);return R(x),P(!0),!0}}),e.jsx(X,{title:s("admin.plan.sync"),description:s("admin.plan.sync-result",{length:b.length,models:L.length}),open:E,setOpen:P,destructive:!0,onSubmit:async()=>(r({type:"set",payload:y}),y&&await C(y),!0)}),e.jsxs("div",{className:"plan-config-row pb-2",children:[e.jsxs(u,{variant:"outline",onClick:()=>D(!0),children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),s("admin.plan.sync")]}),e.jsx("div",{className:"grow"}),e.jsx(u,{variant:"outline",size:"icon",className:"mr-2",onClick:()=>t(!n),children:e.jsx(Y,{icon:n?e.jsx(Z,{}):e.jsx(ee,{}),className:"h-4 w-4"})}),e.jsx(u,{variant:"outline",className:"mr-2",size:"icon",onClick:async()=>await I(),children:e.jsx(se,{className:g("h-4 w-4",h&&"animate-spin")})}),e.jsx(u,{variant:"default",size:"icon",onClick:async()=>await C(),loading:!0,children:e.jsx(xe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"plan-config-row",children:[e.jsx("p",{children:s("admin.plan.enable")}),e.jsx("div",{className:"grow"}),e.jsx(T,{checked:l.enabled,onCheckedChange:i=>r({type:"set-enabled",payload:i})})]}),l.enabled&&l.plans.map((i,x)=>e.jsxs("div",{className:"plan-config-card",children:[e.jsx("p",{className:"plan-config-title",children:s(`sub.${A(i.level)}`)}),e.jsxs("div",{className:"plan-editor-row",children:[e.jsxs("p",{className:"select-none flex flex-row items-center mr-2",children:[s("admin.plan.price"),e.jsx(w,{className:"inline-block",content:s("admin.plan.price-tip")})]}),e.jsx(S,{value:i.price,onValueChange:d=>{r({type:"set-price",payload:{level:i.level,price:d}})}})]}),e.jsx("div",{className:"plan-items-wrapper",children:i.items.map((d,o)=>e.jsxs("div",{className:g("plan-item grid grid-cols-1 md:grid-cols-2 gap-4",n&&"stacked"),children:[e.jsxs("div",{className:"plan-editor-row",children:[e.jsxs("p",{className:"plan-editor-label mr-2",children:[s("admin.plan.item-id"),e.jsx(w,{content:s("admin.plan.item-id-placeholder")})]}),e.jsx(V,{value:d.id,onChange:p=>{r({type:"set-item-id",payload:{level:i.level,id:p.target.value,index:o}})},placeholder:s("admin.plan.item-id-placeholder")})]}),!n&&e.jsxs("div",{className:"plan-editor-row",children:[e.jsxs("p",{className:"plan-editor-label mr-2",children:[s("admin.plan.item-name"),e.jsx(w,{content:s("admin.plan.item-name-placeholder")})]}),e.jsx(V,{value:d.name,onChange:p=>{r({type:"set-item-name",payload:{level:i.level,name:p.target.value,index:o}})},placeholder:s("admin.plan.item-name-placeholder")})]}),e.jsxs("div",{className:"plan-editor-row",children:[e.jsxs("p",{className:"plan-editor-label mr-2",children:[s("admin.plan.item-value"),e.jsx(w,{content:s("admin.plan.item-value-tip")})]}),e.jsx(S,{value:d.value,min:-1,acceptNegative:!0,onValueChange:p=>{r({type:"set-item-value",payload:{level:i.level,value:p,index:o}})}})]}),!n&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"plan-editor-row",children:[e.jsxs("p",{className:"plan-editor-label mr-2",children:[s("admin.plan.item-models"),e.jsx(w,{content:s("admin.plan.item-models-tip")})]}),e.jsx(ae,{align:"start",value:d.models,onChange:p=>{r({type:"set-item-models",payload:{level:i.level,models:p,index:o}})},placeholder:s("admin.plan.item-models-placeholder",{length:d.models.length}),searchPlaceholder:s("admin.plan.item-models-search-placeholder"),list:c,className:"w-full max-w-full"})]})}),e.jsxs("div",{className:g("flex flex-row gap-1",!n&&"flex-wrap"),children:[e.jsxs(u,{variant:"outline",size:n?"icon":"default",onClick:()=>{r({type:"upward-item",payload:{level:i.level,index:o}})},disabled:o===0,children:[e.jsx(le,{className:g("h-4 w-4",!n&&"mr-1")}),!n&&s("upward")]}),e.jsxs(u,{variant:"outline",size:n?"icon":"default",onClick:()=>{r({type:"downward-item",payload:{level:i.level,index:o}})},disabled:o===i.items.length-1,children:[e.jsx(ne,{className:g("h-4 w-4",!n&&"mr-1")}),!n&&s("downward")]}),e.jsxs(u,{variant:"default",size:n?"icon":"default",onClick:()=>{r({type:"remove-item",payload:{level:i.level,index:o}})},children:[e.jsx(ie,{className:g("h-4 w-4",!n&&"mr-1")}),!n&&s("remove")]})]})]},o))}),e.jsxs("div",{className:"plan-items-action",children:[e.jsx(Ne,{plans:l.plans,level:i.level,dispatch:r}),e.jsxs(u,{variant:"default",onClick:()=>{r({type:"add-item",payload:{level:i.level}})},children:[e.jsx(te,{className:"h-4 w-4 mr-1"}),s("admin.plan.add-item")]})]}),e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsxs("p",{className:"plan-config-title flex items-center",children:[s("admin.plan.discounts"),e.jsx(w,{content:s("admin.plan.discounts-tip"),className:"ml-1"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-3",children:[1,3,6,12,36].map(d=>{var z;const o=i.discounts&&i.discounts[d.toString()]!==void 0,p=o?(z=i.discounts)==null?void 0:z[d.toString()]:null;return e.jsxs("div",{className:"flex flex-col space-y-2 p-3 border rounded-md",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:s(`sub.time.${d}`)}),e.jsx(T,{checked:o,onCheckedChange:k=>{if(k){let j=0;d>=36?j=30:d>=12?j=20:d>=6&&(j=10);const B=1-j/100;r({type:"set-discount",payload:{level:i.level,month:d.toString(),value:B}})}else r({type:"remove-discount",payload:{level:i.level,month:d.toString()}})}})]}),o&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:s("admin.plan.discount-value")}),e.jsxs("span",{className:"text-sm font-medium",children:[Math.round((1-(p||1))*100),"% ",s("admin.plan.discount-off")]})]}),e.jsx("div",{className:"mt-2",children:e.jsx(S,{value:Math.round((1-(p||1))*100),min:0,max:90,step:5,onValueChange:k=>{const j=1-k/100;r({type:"set-discount",payload:{level:i.level,month:d.toString(),value:j}})}})})]})]},d)})})]})]},x)),e.jsxs("div",{className:"flex flex-row flex-wrap gap-1",children:[e.jsx("div",{className:"grow"}),e.jsx(u,{loading:!0,onClick:async()=>await C(),children:s("save")})]})]})}function Ie(){const{t:s}=M();return e.jsx("div",{className:"admin-subscription",children:e.jsxs(q,{className:"admin-card sub-card",children:[e.jsx(H,{className:"select-none",children:e.jsx(U,{children:s("admin.subscription")})}),e.jsx(G,{children:e.jsx(be,{})})]})})}export{Ie as default};
